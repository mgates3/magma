# ----------------------------------------
# precision generation
#
# this file is NOT included in the release:
# all precision generation is done prior to release by MakeMagmaRelease.pl,
# and then this file is deleted.

Makefile.gen.$(BACKEND): $(Makefiles) tools/magmasubs.py
	echo "# ----------------------------------------"                     >  $@
	$(codegen) --make --prefix libmagma          $(libmagma_src)          >> $@
	$(codegen) --make --prefix libmagma_dynamic  $(libmagma_dynamic_src)  >> $@
	$(codegen) --make --prefix libtest           $(libtest_src)           >> $@
	$(codegen) --make --prefix liblapacktest     $(liblapacktest_src)     >> $@
	$(codegen) --make --prefix testing           $(testing_src)           >> $@
	$(codegen) --make --prefix libsparse         $(libsparse_src)         >> $@
	$(codegen) --make --prefix libsparse_dynamic $(libsparse_dynamic_src) >> $@
	$(codegen) --make --prefix sparse_testing    $(sparse_testing_src)    >> $@
	$(codegen) --make --prefix header            $(hdr)                   >> $@

newlines := perl -pe 's/ +/\n/g'

generate: $(CMAKESRC)

$(CMAKESRC): Makefile.gen.$(BACKEND)
	echo "# auto-generated by 'make $@'"               >  $@
	echo "# ----------------------------------------"  >> $@
	echo "set( libmagma_src"                           >> $@
	echo    "$(libmagma_src) )"          | $(newlines) >> $@
	echo                                               >> $@
	echo "set( libblas_fix_src"                        >> $@
	echo    "$(libblas_fix_src) )"       | $(newlines) >> $@
	echo                                               >> $@
	echo "set( libtest_src"                            >> $@
	echo    "$(libtest_src) )"           | $(newlines) >> $@
	echo                                               >> $@
	echo "set( liblapacktest_src"                      >> $@
	echo    "$(liblapacktest_src) )"     | $(newlines) >> $@
	echo                                               >> $@
	echo "set( testing_src"                            >> $@
	echo    "$(testing_src) )"           | $(newlines) >> $@
	echo                                               >> $@
	echo "set( libsparse_src"                          >> $@
	echo    "$(libsparse_src)"           | $(newlines) >> $@
	echo    "$(libsparse_dynamic_src) )" | $(newlines) >> $@
	echo                                               >> $@
	echo "set( sparse_testing_src"                     >> $@
	echo    "$(sparse_testing_src) )"    | $(newlines) >> $@
	echo                                               >> $@
	echo "set( header_templates"                       >> $@
	echo    "$(header_templates) )"      | $(newlines) >> $@

# cleanall (defined in Makefile) also deletes Makefile.gen/src
cleanall: cleanmake

cleanmake:
	-rm -f Makefile.gen.$(BACKEND) Makefile.src CMake.src

# preprocessed headers for Fortran wrappers
wrapper_headers = \
	include/magma_s.i \
	include/magma_d.i \
	include/magma_c.i \
	include/magma_z.i \
	include/magmablas_s.i \
	include/magmablas_d.i \
	include/magmablas_c.i \
	include/magmablas_z.i \

# generate Fortran wrappers directly from the headers
wrappers: $(wrapper_headers)
	tools/fortran_wrappers.pl include/magma_s.i
	tools/fortran_wrappers.pl include/magma_d.i
	tools/fortran_wrappers.pl include/magma_c.i
	tools/fortran_wrappers.pl include/magma_z.i
	tools/fortran_wrappers.pl include/magmablas_s.i
	tools/fortran_wrappers.pl include/magmablas_d.i
	tools/fortran_wrappers.pl include/magmablas_c.i
	tools/fortran_wrappers.pl include/magmablas_z.i
	rm $^
